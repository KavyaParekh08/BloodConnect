<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Donor Map - Blood Donation Tracker</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <!-- Tailwind CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #FFFFFF; color: #000000; display: flex; height: 100vh; margin: 0; }
    #map { width: calc(100% - 300px); height: 100%; border-radius: 0; box-shadow: none; position: absolute; right: 0; }
    .sidebar { width: 300px; height: 100%; background: #FFFFFF; padding: 20px; overflow-y: auto; border-right: 2px solid #B22222; }
    .card { background: #FFFFFF; border-radius: 8px; border: 2px solid #B22222; padding: 15px; margin-bottom: 15px; }
    button { transition: all 0.3s ease; border-radius: 6px; font-weight: 600; background: #B22222; color: #FFFFFF; border: none; padding: 8px 16px; width: 100%; margin-bottom: 10px; }
    button:hover { transform: translateY(-2px); background: #8B0000; box-shadow: 0 4px 12px rgba(178, 34, 34, 0.3); }
    .tracking-active { animation: pulse 2s infinite; }
    .progress-bar { background: #F5F5F5; border-radius: 9999px; overflow: hidden; }
    .progress-fill { background: #B22222; transition: width 0.3s ease; height: 8px; }
    .spinner { border: 2px solid #FFFFFF; border-top: 2px solid #B22222; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-left: 6px; }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .dark-mode { background-color: #1C2526; color: #FFFFFF; }
    .dark-mode .card, .dark-mode .info { background: #2E2E2E; border-color: #B22222; color: #FFFFFF; }
    .toast { 
      position: fixed; 
      top: 20px; 
      right: 20px; 
      padding: 12px 24px; 
      border-radius: 6px; 
      color: #FFFFFF; 
      font-weight: 600; 
      z-index: 1000; 
      min-width: 200px; 
      max-width: 90%; 
      transform: translateX(100%); 
      transition: transform 0.3s ease; 
      border: 1px solid #B22222; 
      background: #B22222; 
      word-break: break-word; 
    }
    .toast.show { transform: translateX(0); }
    @media (max-width: 768px) {
      #map { width: 100%; height: 70%; position: relative; }
      .sidebar { width: 100%; height: auto; }
      .toast { top: 10px; right: 10px; left: 10px; transform: translateY(-100%); min-width: unset; max-width: 95%; }
      .toast.show { transform: translateY(0); }
    }
    select { width: 100%; padding: 8px; border-radius: 6px; border: 2px solid #B22222; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="card">
      <h1 class="text-2xl font-bold mb-2 text-black">ü©∏ Blood Donation Tracker</h1>
      <p class="text-sm mb-4 text-gray-700">Track your journey to the hospital</p>
      <button id="darkModeToggle" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 mb-4 w-auto text-black">üåô</button>
      <select id="hospitalSelect" class="mb-4" disabled>
        <option value="custom">Loading...</option>
      </select>
      <button id="acceptBtn" class="flex items-center">
        <span class="mr-2">‚úÖ</span> Accept Hospital Request
      </button>
      <button id="startTrackingBtn" class="flex items-center">
        <span class="mr-2">üöó</span> Start Tracking
      </button>
      <button id="stopTrackingBtn" class="hidden flex items-center">
        <span class="mr-2">üõë</span> Stop Tracking
      </button>
      <button id="recenterBtn" class="flex items-center">
        <span class="mr-2">üìç</span> Recenter Map
      </button>
      <button id="shareLocationBtn" class="flex items-center">
        <span class="mr-2">üì§</span> Share Location
      </button>
    </div>
    <div id="info" class="card">
      <div id="welcomeInfo" class="text-center">
        <h2 class="text-lg font-semibold mb-2 text-black">Ready to start?</h2>
        <p class="text-sm text-gray-700">Click "Start Tracking" to begin your journey.</p>
      </div>
      <div id="trackingInfo" class="hidden">
        <div class="grid grid-cols-2 gap-2 mb-2">
          <div class="text-center">
            <div class="text-lg font-bold text-black" id="distance">0 km</div>
            <div class="text-xs text-gray-700">Distance</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-black" id="etaORS">0 min</div>
            <div class="text-xs text-gray-700">ETA (ORS)</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-black" id="etaHaversine">0 min</div>
            <div class="text-xs text-gray-700">ETA (Haversine)</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-black" id="speed">0 km/h</div>
            <div class="text-xs text-gray-700">Speed</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-black" id="heading">0¬∞</div>
            <div class="text-xs text-gray-700">Heading</div>
          </div>
        </div>
        <div class="progress-bar mb-2">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="text-center text-xs text-gray-700" id="progressText">Progress: 0%</div>
        <div id="arrivalMsg" class="hidden text-center mt-2 p-2 bg-red-100 rounded">
          <h3 class="text-md font-semibold text-red-800">üéâ Arrived!</h3>
          <p class="text-sm text-red-700">Thank you for your donation.</p>
        </div>
      </div>
    </div>
  </div>
  <div id="map"></div>
  <div id="toast" class="toast hidden"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <!-- Leaflet RotatedMarker Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>
  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Supabase JS Client (using a reliable CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    // Supabase configuration (hardcoded for testing, replace with your keys)
    const SUPABASE_URL = "https://acqyahtrxbazoylqqadf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjcXlhaHRyeGJhem95bHFxYWRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDE4OTksImV4cCI6MjA3MzU3Nzg5OX0.v4Pu4CgDPYbymqHw4Qc2tH6aABViv-6ZRgtCGauJI_0";
    const ORS_API_KEY = "5b3ce3597851110001cf6248f4b3f9a7f0b94e3e83e7f8b9f0c0a5d2"; // Replace with your ORS key
    let client;
    try {
      client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log("Supabase client initialized");
    } catch (err) {
      console.error("Supabase initialization failed:", err.message);
      showToast("Failed to connect to database. Map will still work.", "yellow");
    }

    const AVERAGE_SPEED_KMH = 30; // km/h for Haversine ETA

    // DOM elements
    const hospitalSelect = document.getElementById("hospitalSelect");
    const acceptBtn = document.getElementById("acceptBtn");
    const startTrackingBtn = document.getElementById("startTrackingBtn");
    const stopTrackingBtn = document.getElementById("stopTrackingBtn");
    const recenterBtn = document.getElementById("recenterBtn");
    const shareLocationBtn = document.getElementById("shareLocationBtn");
    const mapDiv = document.getElementById("map");
    const infoDiv = document.getElementById("info");
    const welcomeInfo = document.getElementById("welcomeInfo");
    const trackingInfo = document.getElementById("trackingInfo");
    const distanceEl = document.getElementById("distance");
    const etaORSEl = document.getElementById("etaORS");
    const etaHaversineEl = document.getElementById("etaHaversine");
    const speedEl = document.getElementById("speed");
    const headingEl = document.getElementById("heading");
    const progressFill = document.getElementById("progressFill");
    const progressText = document.getElementById("progressText");
    const arrivalMsg = document.getElementById("arrivalMsg");
    const darkModeToggle = document.getElementById("darkModeToggle");
    const toast = document.getElementById("toast");

    let map, donorMarker, routePolyline, isTracking = false, heading = 0, lastPosition = null, watchId = null;
    let totalDistance = 0, lastTime = null, routeDistance = 0, arrived = false, initialETAORS = 0;
    let hospitalLocation = null;

    // Car icon for donor
    const carIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/3202/3202003.png',
      iconSize: [40, 40],
      iconAnchor: [20, 20],
      popupAnchor: [0, -20]
    });

    // Hospital icon
    const hospitalIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/1483/1483336.png',
      iconSize: [40, 40],
      iconAnchor: [20, 20],
      popupAnchor: [0, -20]
    });

    // Dark mode toggle
    darkModeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      darkModeToggle.textContent = document.body.classList.contains("dark-mode") ? "‚òÄÔ∏è" : "üåô";
      if (document.body.classList.contains("dark-mode")) {
        document.body.style.background = "#1C2526";
        document.querySelectorAll('.card, .info').forEach(el => {
          el.style.background = "#2E2E2E";
          el.style.color = "#FFFFFF";
        });
        mapDiv.style.boxShadow = "0 4px 20px rgba(0, 0, 0, 0.4)";
      } else {
        document.body.style.background = "#FFFFFF";
        document.querySelectorAll('.card, .info').forEach(el => {
          el.style.background = "#FFFFFF";
          el.style.color = "#000000";
        });
        mapDiv.style.boxShadow = "none";
      }
    });

    // Show toast
    function showToast(message, type = 'red') {
      toast.textContent = message;
      toast.className = `toast bg-${type}-500 show`;
      setTimeout(() => {
        toast.classList.remove("show");
      }, 4000);
    }

    // Haversine distance calculation
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // Distance in km
    }

    // Calculate bearing between two points
    function calculateBearing(lat1, lon1, lat2, lon2) {
      const dLon = (lon2 - lon1) * Math.PI / 180;
      lat1 = lat1 * Math.PI / 180;
      lat2 = lat2 * Math.PI / 180;
      const y = Math.sin(dLon) * Math.cos(lat2);
      const x = Math.cos(lat1) * Math.sin(lat2) -
                Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
      const bearing = Math.atan2(y, x) * 180 / Math.PI;
      return (bearing + 360) % 360;
    }

    // Calculate initial route using ORS
    async function calculateInitialRoute(donorLocation, retryCount = 0) {
      if (!hospitalLocation || arrived) return;

      try {
        const response = await axios.get(`https://api.openrouteservice.org/v2/directions/driving-car`, {
          params: {
            api_key: ORS_API_KEY,
            start: `${donorLocation.lng},${donorLocation.lat}`,
            end: `${hospitalLocation.lng},${hospitalLocation.lat}`
          }
        });

        const route = response.data.features[0];
        routeDistance = route.properties.summary.distance / 1000; // in km
        initialETAORS = route.properties.summary.duration / 60; // in minutes

        if (routePolyline) map.removeLayer(routePolyline);
        routePolyline = L.polyline(route.geometry.coordinates.map(coord => [coord[1], coord[0]]), {
          color: '#B22222',
          weight: 5
        }).addTo(map);

        const remainingDistance = calculateDistance(donorLocation.lat, donorLocation.lng, hospitalLocation.lat, hospitalLocation.lng);
        const haversineETA = (remainingDistance / AVERAGE_SPEED_KMH) * 60; // in minutes
        const progress = Math.max(0, ((routeDistance - remainingDistance) / routeDistance) * 100);

        distanceEl.textContent = `${remainingDistance.toFixed(2)} km`;
        etaORSEl.textContent = `${initialETAORS.toFixed(1)} min`;
        etaHaversineEl.textContent = `${haversineETA.toFixed(1)} min`;
        speedEl.textContent = `${(lastPosition && lastPosition.speed ? lastPosition.speed : 0).toFixed(1)} km/h`;
        headingEl.textContent = `${Math.round(heading)}¬∞`;
        progressFill.style.width = `${progress}%`;
        progressText.textContent = `Progress: ${progress.toFixed(1)}%`;

        if (remainingDistance < 0.05 && !arrived) {
          arrived = true;
          arrivalMsg.classList.remove("hidden");
          stopTracking();
          showToast("You have arrived at the hospital! Thank you for your donation!");
        }
      } catch (err) {
        console.error("Error fetching route:", err);
        if (retryCount < 3) {
          setTimeout(() => calculateInitialRoute(donorLocation, retryCount + 1), 2000);
        } else {
          showToast("Failed to fetch route. Using Haversine distance.", "yellow");
          const remainingDistance = calculateDistance(donorLocation.lat, donorLocation.lng, hospitalLocation.lat, hospitalLocation.lng);
          const haversineETA = (remainingDistance / AVERAGE_SPEED_KMH) * 60;
          distanceEl.textContent = `${remainingDistance.toFixed(2)} km`;
          etaORSEl.textContent = "N/A";
          etaHaversineEl.textContent = `${haversineETA.toFixed(1)} min`;
        }
      }
    }

    // Start device orientation
    function startDeviceOrientation() {
      if (window.DeviceOrientationEvent) {
        window.deviceOrientationSupported = true;
        window.addEventListener('deviceorientation', (event) => {
          heading = event.alpha ? 360 - event.alpha : heading;
          if (donorMarker) {
            donorMarker.setRotationAngle(heading);
          }
        });
      } else {
        window.deviceOrientationSupported = false;
        console.warn("Device orientation not supported.");
      }
    }

    // Initialize map
    function initializeMap(lat, lng) {
      map = L.map("map", {
        zoomControl: true,
        fullscreenControl: true,
        maxZoom: 18,
        minZoom: 10
      }).setView([lat, lng], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>'
      }).addTo(map);
    }

    // Initialize map and hospital from URL parameters
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const lat = parseFloat(urlParams.get('lat'));
      const lng = parseFloat(urlParams.get('lng'));
      const hospitalName = urlParams.get('hospitalName') || "Selected Hospital";
      const address = urlParams.get('address') || "No address provided";

      if (!isNaN(lat) && !isNaN(lng)) {
        // Use URL parameters
        hospitalLocation = { lat, lng, hospital_name: hospitalName, address };
        hospitalSelect.innerHTML = `<option value="custom" selected>${hospitalName} - ${address}</option>`;
        hospitalSelect.disabled = true;

        // Initialize map and add hospital marker
        initializeMap(lat, lng);
        L.marker([lat, lng], { icon: hospitalIcon })
          .addTo(map)
          .bindPopup(`üè• ${hospitalName}<br>${address}`)
          .openPopup();

        // Show UI
        acceptBtn.classList.remove("hidden");
        startTrackingBtn.classList.remove("hidden");
        recenterBtn.classList.remove("hidden");
        shareLocationBtn.classList.remove("hidden");
        infoDiv.classList.remove("hidden");
        welcomeInfo.classList.remove("hidden");
        trackingInfo.classList.add("hidden");

        showToast(`Hospital selected: ${hospitalName}`);
      } else {
        // Fallback to default location (Mumbai)
        hospitalLocation = {
          lat: 19.2088,
          lng: 72.8392,
          hospital_name: "Default Hospital",
          address: "Mumbai, India"
        };
        hospitalSelect.innerHTML = `<option value="custom" selected>Default Hospital - Mumbai, India</option>`;
        hospitalSelect.disabled = true;

        initializeMap(19.2088, 72.8392);
        L.marker([19.2088, 72.8392], { icon: hospitalIcon })
          .addTo(map)
          .bindPopup("üè• Default Hospital<br>Mumbai, India")
          .openPopup();

        showToast("No hospital specified. Using default location.", "yellow");
      }
    });

    acceptBtn.addEventListener("click", () => {
      acceptBtn.classList.add("hidden");
      showToast(`Hospital request accepted for ${hospitalLocation.hospital_name}!`);
    });

    startTrackingBtn.addEventListener("click", () => {
      if (!isTracking && hospitalLocation) {
        isTracking = true;
        startTrackingBtn.innerHTML = '<span class="mr-2">üöó</span> Tracking... <span class="spinner"></span>';
        startTrackingBtn.classList.add("tracking-active", "pointer-events-none");
        stopTrackingBtn.classList.remove("hidden");
        trackingInfo.classList.remove("hidden");
        welcomeInfo.classList.add("hidden");

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const currentTime = Date.now();
            const donorLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            lastPosition = donorLocation;
            lastTime = currentTime;
            totalDistance = 0;

            donorMarker = L.marker([donorLocation.lat, donorLocation.lng], {
              icon: carIcon,
              rotationAngle: 0,
              rotationOrigin: 'center center'
            }).addTo(map).bindPopup("üöó Your Location");

            map.setView([donorLocation.lat, donorLocation.lng], 15);
            calculateInitialRoute(donorLocation);
            startContinuousTracking();
            startDeviceOrientation();

            showToast("Tracking started!");
          },
          (err) => {
            console.error("Initial position error:", err);
            showToast(`Error getting position: ${err.message}`, "red");
            resetTracking();
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 }
        );
      } else {
        showToast("No hospital selected.", "yellow");
      }
    });

    function startContinuousTracking() {
      if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition((pos) => {
          const currentTime = Date.now();
          const donorLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };

          if (lastPosition && calculateDistance(lastPosition.lat, lastPosition.lng, donorLocation.lat, donorLocation.lng) < 0.01) {
            return;
          }

          let currentSpeed = pos.coords.speed ? pos.coords.speed * 3.6 : 0;
          if (lastPosition && lastTime && !pos.coords.speed) {
            const timeDelta = (currentTime - lastTime) / 1000 / 3600;
            const distDelta = calculateDistance(lastPosition.lat, lastPosition.lng, donorLocation.lat, donorLocation.lng);
            currentSpeed = (distDelta / timeDelta) || 0;
            totalDistance += distDelta;
          }
          lastTime = currentTime;

          let movementHeading = heading;
          if (lastPosition && Object.keys(lastPosition).length > 0) {
            movementHeading = calculateBearing(lastPosition.lat, lastPosition.lng, donorLocation.lat, donorLocation.lng);
          }
          lastPosition = donorLocation;

          const finalHeading = window.deviceOrientationSupported ? heading : movementHeading;

          donorMarker.setLatLng([donorLocation.lat, donorLocation.lng]);
          donorMarker.setRotationAngle(finalHeading);
          map.setView([donorLocation.lat, donorLocation.lng], 15);
          calculateInitialRoute(donorLocation);

        }, (err) => {
          console.error("GPS error:", err);
          showToast(`GPS error: ${err.message}`, "red");
        }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 });
      } else {
        showToast("Geolocation not supported.", "red");
        resetTracking();
      }
    }

    function resetTracking() {
      isTracking = false;
      startTrackingBtn.innerHTML = '<span class="mr-2">üöó</span> Start Tracking';
      startTrackingBtn.classList.remove("tracking-active", "pointer-events-none");
    }

    stopTrackingBtn.addEventListener("click", () => {
      stopTracking();
      showToast("Tracking stopped.");
    });

    function stopTracking() {
      isTracking = false;
      arrived = false;
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      if (donorMarker) {
        map.removeLayer(donorMarker);
        donorMarker = null;
      }
      if (routePolyline) {
        map.removeLayer(routePolyline);
        routePolyline = null;
      }
      startTrackingBtn.innerHTML = '<span class="mr-2">üöó</span> Start Tracking';
      startTrackingBtn.classList.remove("tracking-active", "pointer-events-none");
      stopTrackingBtn.classList.add("hidden");
      trackingInfo.classList.add("hidden");
      welcomeInfo.classList.remove("hidden");
      arrivalMsg.classList.add("hidden");
      progressFill.style.width = "0%";
      progressText.textContent = "Progress: 0%";
    }

    recenterBtn.addEventListener("click", () => {
      if (donorMarker) {
        map.setView(donorMarker.getLatLng(), 15);
        showToast("Map recentered.");
      } else if (hospitalLocation) {
        map.setView([hospitalLocation.lat, hospitalLocation.lng], 12);
        showToast("Map recentered on hospital.");
      } else {
        showToast("No location available.", "yellow");
      }
    });

    shareLocationBtn.addEventListener("click", async () => {
      if (lastPosition) {
        const shareData = {
          title: 'My Location for Blood Donation',
          text: `I'm heading to ${hospitalLocation.hospital_name}. Current location: ${lastPosition.lat.toFixed(6)}, ${lastPosition.lng.toFixed(6)}`,
          url: `https://www.google.com/maps?q=${lastPosition.lat},${lastPosition.lng}`
        };
        if (navigator.share) {
          try {
            await navigator.share(shareData);
            showToast("Location shared successfully!");
          } catch (err) {
            navigator.clipboard.writeText(shareData.url);
            showToast("Location link copied to clipboard!");
          }
        } else {
          navigator.clipboard.writeText(shareData.url);
          showToast("Location link copied to clipboard!");
        }
      } else {
        showToast("Location not available yet.", "yellow");
      }
    });
  </script>
</body>
</html>